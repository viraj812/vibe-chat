// Dependencies
var express = require('express');
var mongoose = require('mongoose');
var bodyParser = require('body-parser');
var cors = require('cors');
var path = require('path');
var restImpl = require('./routes/upload');

// MongoDB
mongoose.connect('mongodb://localhost/agenda-cultural');

// Express
var app = express();

// CORS

// ***************************
// IMPORTANTE
// ***************************
// DESSA FORMA, ACEITA QUALQUER REQUISIÇÃO DE QUALQUER SERVIDOR, INCLUSIVE POST E DELETE
// PARA PRODUÇÃO, IMPLEMENTAR APENAS PARA GET.
// COM ISSO, A API DEVERÁ ESTAR HOSPEDADA NO MESMO LOCAL DA ÁREA RESTRITA
// PARA QUE AS REQUISIÇÕES VENHAM DO MESMO SERVIDOR
// QUALQUER DÚVIDA, PESQUISAR NO GOOGLE POR 'CORS EXPRESSJS'
app.use(cors());
app.use(function(req, res, next) 
{
  res.header("Access-Control-Allow-Origin", "*"); 
  res.header("Access-Control-Allow-Headers", "X-Requested-With");
  next();
});
app.use(bodyParser.urlencoded({extended: true, defer:true, limit: '50mb'}));
app.use(bodyParser.json({limit: '50mb'}));


// Routes
app.use('/api', auth, require('./routes/api'));
app.use("/img", express.static(__dirname + "/img"));
app.use("/uploads", express.static(__dirname + "/uploads"));

app.post('/upload', auth, restImpl.uploadImage);

function auth(req, res, next) 
{
  if (req.method != 'GET')
  {//get deixar aberto para o app poder pegar os dados e afinal, dados da prefeitura, são dados pra todos =P
    if (req.headers['gautica-secret-key'] == 'WxtU(s7$ts709g<')
    {
      next();
    } 
    else 
    {
      res.json({ error: 'Invalid Token' });
    }
  }
  else
  {
    next();
  }
}
 
// Start server
app.listen(3000);
console.log('API rodando na porta 3000, com CORS ativo.');